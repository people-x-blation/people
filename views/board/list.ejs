<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>피플</title>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/style.css?ver=1" />
    <script src="/javascript/base.js"></script>
</head>

<body>
    <!-- Loading -->
    <div id="loading">
        <img src="/images/logo.svg">
        <span>로딩중 입니다...</span>
    </div>

    <!-- NAVBAR -->
    <nav>
        <ul>
            <li><a href="/board"><img id="nav_home" src="/images/home.svg" alt="홈" /></a><span id="nav_home_span">홈</span></li>
            <li><a href="/board/search"><img id="nav_search" src="/images/search.svg" alt="검색" /></a><span id="nav_search_span">검색</span></li>
            <li><a href="/board/write"><img id="nav_write" src="/images/write.svg" alt="글 작성" /></a><span id="nav_write_span">요청글 작성</span></li>
            <li><a href="/auth/login"><img id="nav_login" src="/images/login.svg" alt="로그인" /></a><span id="nav_login_span">로그인</span></li>
            <li><a href="/auth/kakao/logout"><img id="nav_logout" src="/images/logout.svg" alt="로그아웃" /></a><span id="nav_logout_span">로그아웃</span></li>
            <li><a href="/auth/kakao?requestUrl=/board"><img id="nav_signup" src="/images/signup.svg" alt="회원가입" /></a><span id="nav_signup_span">회원가입</span></li>
            <li><a href="/auth/mypage"><img id="nav_mypage" src="/images/mypage.svg" alt="마이페이지" /></a><span id="nav_mypage_span">마이페이지</span></li>
        </ul>
    </nav>

    <h2 id="list_header_location"><%=(location == 0) ? '전체보기' : location %></h2>
    <div id = "wrapper">
        <% if(list.length == 0) { %>
        <span id="list_no_result">아직 해당 지역의 요청이 없습니다...</span>
        <img id="list_no_result_img" src="/images/empty.svg" alt="결과 없음"/>
        <% } else { %>
        <% for(let item=0 ; item<list.length; item++){ %>
        <div class="list_container">
        
            <div class="img_wrapper"
                style="background:url('https://i.imgur.com/4KyfXrZ.jpg');background-size: cover;background-repeat: no-repeat;background-position: center center;">
                <!-- 이미지 영역 -->
            </div>
            <div class="content_wrapper">
                <hidden id='boardnum' value=<%=list[item].boardnum%></hidden>
                <span id="list_user_id"><%=list[item].nickname%></span>
                <h2 id="list_title"><a href="board/read/<%=list[item].boardnum%>"><%=list[item].title%></a></h2>
                <h2 id="list_like_likecount"><a href="board/read"><%=list[item].like_count%></a></h2>
                <span id="list_location"><%=locationTable[list[item].location]%></span> | <span id="list_blood_type"><%=list[item].blood%></span>
            </div>
        </div>
        <%} }%>
    </div>
  



    <script src="/jquery/jquery.min.js"></script>
    <script>
        
        $( document ).ready( function() {
            

        let renderList = function(vo){

            const html = '<div class="list_container">'+
                '<div class="img_wrapper"'+
                    'style="background:url(\'https://i.imgur.com/4KyfXrZ.jpg\');background-size: cover;background-repeat: no-repeat;background-position: center center;">'+
                '</div>'+
                '<div class="content_wrapper">'+
                    '<hidden id="boardnum" value='+vo.boardnum+'</hidden>'+
                    '<span id="list_user_id"> '+vo.nickname +'</span>'+
                    '<h2 id="list_title"><a href="board/read"> '+ vo.title +'</a></h2>'+
                    '<h2 id="list_like_likecount"><a href="board/read"> '+ vo.like_count +'</a></h2>'+
                    '<span id="list_location"> '+$('list_location').text() +'</span> | <span id="list_blood_type"> '+ vo.blood +'</span>'+
                '</div>'+
                '<div class="content_wrapper">'+
                    '<span id="list_content"> '+ vo.content +'</span>'+
                '</div>'+
            '</div>';
    
            $("#wrapper").append(html);
   
        }
            let key = true;
            let page = 2;
            let isEnd = false;
            
            $(function(){
                $(window).scroll(function(){
                    let $window = $(this);
                    let scrollTop = $window.scrollTop();
                    let windowHeight = $window.height();
                    let documentHeight = $(document).height();

                    if (scrollTop + windowHeight + 500 >= documentHeight && key) {
                        key = false;
                        fetchList();
                        page++;
                        

                    }
                })
            })
            let fetchList = function(){
            if(isEnd == true){
                return;
            }
            
            $.ajax({
                url:"/board/"+$('#list_location').text()+"?page=" + page ,
                type: "GET",
                dataType: "json",
                success: function(result){
                    let length = result.length;
                    if( length < 10 ){
                        isEnd = true;
                    }

                    key = true;
    
                    $.each(result, function(index, vo){
                        renderList(vo);
                    })
                },
                error: function(err){
                    console.log(err)
                }
            });
        }
        })

    </script>
</body>

</html>